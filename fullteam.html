<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FullTeam - Cari Teman Mabar</title>
<link rel="stylesheet" href="style.css" />

</head>

<body>

<header>
  <div class="header-inner" style="display:flex;align-items:center;justify-content:space-between;gap:32px;max-width:100vw;padding: 16px 32px;">
    <!-- Kiri: Logo & Menu -->
    <div style="display:flex;align-items:center;gap:32px;min-width:220px;">
      <h1 class="header-title" aria-label="Logo FullTeam" style="margin:0;padding-left: 250px;">FullTeam</h1>
      <button class="btn-menu" type="button" style="padding-right: 10px;margin-top: 10px;"onclick="setActiveMenu(this)">Main Bareng</button>
    </div>
    <!-- Tengah: Search Bar -->
    <form id="globalSearchBar" onsubmit="return false;"
      style="flex:1;min-width:320px;display:flex;align-items:right;box-shadow:0 2px 8px rgba(0,0,0,0.07);background:#fff;border-radius:32px;padding:2px 18px 2px 12px;position:relative;margin:0 32px;">
      <span style="display:flex;align-items:center;justify-content:center;">
        <img src="https://img.icons8.com/ios-filled/24/cccccc/search--v1.png" alt="Cari" style="width:22px;height:22px;margin-right:24px;margin-left: 12px;"/>
      </span>
      <input type="text" id="globalEventSearchInput"
        placeholder="Cari event..."
        style="border:none;outline:none;background:transparent;font-size:1.08rem;flex:1;padding:10px 0 10px 0;border-radius:32px;">
    </form>
    <!-- Kanan: Auth Buttons -->
    <div class="auth-buttons" style="display:flex;align-items:center;gap:12px;">
      <!-- ...auth buttons & dropdown... -->
      <div class="eventku-dropdown" style="display:none;position:relative;margin-right: 0px;">
        <button id="btnEventDropdown" style="cursor:pointer;width:28px;height:28px;vertical-align:middle;margin-right: 30px;">
          <img src="assets/pencil.png" alt="Event Menu" style="width:28px;height:28px;" />
        </button>
        <div id="eventDropdownMenu" style="display:none;position:absolute;top:36px;right:30px;background:#fff;border:1px solid #ddd;border-radius:8px;box-shadow:0 2px 12px rgba(0,0,0,0.08);min-width:140px;z-index:1000;margin-top: 10px;">
          <button type="button" class="dropdown-item2" id="btnEventku" style="width:100%;padding:10px 18px;text-align:left;border:none;background:none;">Eventku</button>
          <button type="button" class="dropdown-item" id="btnBuatEvent" style="width:100%;padding:10px 18px;text-align:left;border:none;background:none;">Buat Event</button>
        </div>
      </div>
      <img id="btnAddMabarProfile" 
        src="assets/pencil.png" 
        alt="Buat Event Main Bareng" 
        title="Buat Event Main Bareng"
        style="cursor:pointer;width:28px;height:28px;vertical-align:middle;margin-right:10px;display:none;" />
      <button class="btn-masuk" type="button" style="margin-right: 10px;">Masuk</button>
      <button class="btn-daftar" type="button" style="margin-right: 250px;">Daftar</button>
      <button class="btn-profile" type="button" style="display:none;cursor:pointer;margin-right: 300px;">
        <img src="https://img.icons8.com/ios/40/000000/user-male-circle--v2.png" alt="Profil" style="width:28px;height:28px;border-radius:50%;" />
      </button>
      <div class="profile-dropdown" id="profileDropdown" style="display:none;position:absolute;top:48px;margin-right: 300px;padding-bottom: 10px;">
        <button type="button" class="dropdown-item" id="btnProfile">Profile</button>
        <button type="button" class="dropdown-item" id="btnDashboard">Dashboard</button>
        <button type="button" class="dropdown-item" id="btnLogout">Logout</button>
      </div>
    </div>
  </div>
</header>

<!-- Halaman Data Diri User -->
<div id="profilePage" style="display:none; max-width:500px; margin:40px auto; background:#fff; border-radius:12px; box-shadow:0 2px 16px rgba(0,0,0,0.08); padding:32px;">
  <h2>Profile</h2>
  <form id="editProfileForm">
    <div style="margin-bottom:18px;">
      <label>Nama Lengkap <span style="color:red">*</span></label><br>
      <input type="text" id="editNama" name="nama" required style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;">
    </div>
    <div style="margin-bottom:18px;">
      <label>Username <span style="color:red">*</span></label><br>
      <input type="text" id="editUsername" name="username" required style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;">
    </div>
    <div style="margin-bottom:18px;">
      <label>Nomor Ponsel</label><br>
      <input type="text" id="editPonsel" name="ponsel" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;">
    </div>
    <div style="margin-bottom:18px;">
      <label>Email</label><br>
      <input type="email" id="editEmail" name="email" readonly style="width:100%;padding:8px;border-radius:6px;border:1px solid #eee;background:#f7f7f7;">
    </div>
    <div style="display: flex; margin-top: 24px;">
    <button type="button" id="btnGoBackProfile" style="background: #fff; color: #222; border:1px solid #bbb; border-radius:6px; padding:10px 24px; margin-left:155px;">Kembali</button>
    <button type="submit" style="padding:10px 24px;border-radius:6px;background:#2563eb;color:#fff;border:none; margin-left: auto;">Simpan Perubahan</button>
    </div>
  </form>
</div>

<!-- Dashboard Main Bareng -->
<div id="dashboardPage" style="display:none;max-width:700px;margin:40px auto;padding:32px 24px;background:#fff;border-radius:12px;box-shadow:0 2px 16px rgba(0,0,0,0.06);">
  <h2 style="font-size:1.6rem;font-weight:600;margin-bottom:24px;">Dashboard</h2>
  <div style="display:flex;gap:32px;margin-bottom:24px;">
  </div>
  <div style="display:flex;gap:12px;margin-bottom:20px;">
    <input type="text" id="searchEventName" placeholder="Cari mabar disini" style="flex:1;padding:10px 14px;border:1px solid #ddd;border-radius:6px;">
    <div style="position:relative;min-width:180px;">
  <button id="dropdownCaborBtn" type="button" style="width:100%;padding:10px 14px;border:1px solid #ddd;border-radius:8px;background:#fff;display:flex;justify-content:space-between;align-items:center;cursor:pointer;">
    <span id="dropdownCaborLabel">Semua Cabor</span>
    <span style="font-size:1.2em;">&#9662;</span>
  </button>
  <div id="dropdownCaborList" style="display:none;position:absolute;top:110%;left:0;width:100%;background:#fff;border:1px solid #ddd;border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,0.08);z-index:10;max-height:220px;overflow-y:auto;">
    <div class="dropdown-cabor-item" data-value="">Semua Cabor</div>
    <div class="dropdown-cabor-item" data-value="Badminton">Badminton</div>
    <div class="dropdown-cabor-item" data-value="Basketball">Basketball</div>
    <div class="dropdown-cabor-item" data-value="Billiard">Billiard</div>
    <div class="dropdown-cabor-item" data-value="Futsal">Futsal</div>
    <div class="dropdown-cabor-item" data-value="Sepak Bola">Sepak Bola</div>
    <div class="dropdown-cabor-item" data-value="Tenis Meja">Tenis Meja</div>
    <div class="dropdown-cabor-item" data-value="Volley">Volley</div>
  </div>
</div>
    <input type="date" id="searchEventDate" placeholder="Tanggal main" style="padding:10px 14px;border:1px solid #ddd;border-radius:6px;width:140px;">
  </div>
  <div style="display:flex;gap:8px;margin-bottom:24px;flex-wrap:wrap;">
    <button class="status-filter-btn active" data-status="all">Semua Status</button>
    <button class="status-filter-btn" data-status="waiting_payment">Menunggu Pembayaran</button>
    <button class="status-filter-btn" data-status="joined">Bergabung</button>
    <button class="status-filter-btn" data-status="cancelled">Dibatalkan</button>
    <button class="status-filter-btn" data-status="finished">Selesai</button>
  </div>
  <div id="dashboardMainbarengGrid"></div>
</div>

<div id="authModal" class="auth-modal" style="display:none;">
  <div class="auth-modal-content">
    <span class="auth-modal-close" id="authModalClose">&times;</span>
    <div id="authModalBody"></div>
  </div>
</div>

<!-- Eventku -->
<div id="eventkuPage" style="display:none;max-width:700px;margin:40px auto;padding:32px 24px;background:#fff;border-radius:12px;box-shadow:0 2px 16px rgba(0,0,0,0.06);">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0;">
    <h2 style="font-size:1.6rem;font-weight:600;margin-bottom:0;">Eventku</h2>
    <span id="eventkuStatusLabel" style="font-size:1.6rem;font-weight:500;min-width:110px;text-align:center;padding:6px 18px;color:#222;margin-top: 20px;">Status</span>
  </div>
  <hr style="border: none; border-top: 1.5px solid #eee; margin: 20px 0 0 0;">
  <div id="eventkuList"></div>
</div>

<main>
  <!-- Section untuk Main Bareng -->
  <section id="mainBarengSection" style="display:none;">
  <div class="mainbareng-filter-row" style="display:flex;justify-content:flex-end;align-items:center;margin-bottom:24px;gap:12px;margin-top: 100px;">
    <div class="autocomplete-location" style="min-width:220px;">
      <input type="text" id="mainbarengLocationAutocomplete" placeholder="Pilih Kota" autocomplete="off" />
      <ul id="mainbarengLocationSuggestions" class="suggestions-list"></ul>
    </div>
    <button class="filter-modal-btn" id="btnOpenFilterModal" type="button" style="background:#fff;border:1px solid #ddd;border-radius:6px;padding:6px 16px;display:flex;align-items:center;gap:6px;">
      <img src="assets/filter.svg" alt="Filter" style="width:22px;height:22px;vertical-align:middle;" />
      <span style="font-size:1rem;">Filter</span>
    </button>
    <button class="filter-btn" onclick="filterMainbareng()" style="padding:8px 22px;border-radius:6px;background:#b71c1c;color:#fff;font-weight:600;border:none;">Cari mabar</button>
  </div>
  <div id="mainbarengCount" style="margin-bottom:0px;font-size:1rem;color:#5f5f5f;"></div>
  <div id="mainbarengGrid" class="mainbareng-grid" style="min-height: 200px;"></div>
  <div id="mainbarengDetailContainer" style="display:none;"></div>
</section>
</main>

<!-- Modal Filter -->
<div id="filterModal" class="filter-modal" style="display:none;">
  <div class="filter-modal-content">
    <span class="filter-modal-close" id="filterModalClose">&times;</span>
    <h3>Filter Event</h3>
    <div style="margin-bottom:18px;">
      <label>Metode Pembayaran</label>
      <div id="filterMetodeGroup" class="filter-btn-group">
        <button type="button" class="filter-btn-option" data-value="online_tunai">Online & Tunai</button>
        <button type="button" class="filter-btn-option" data-value="online">Online</button>
        <button type="button" class="filter-btn-option" data-value="tunai">Tunai</button>
      </div>
    </div>
    <div style="margin-bottom:18px;">
      <label>Waktu Mabar</label>
      <div id="filterWaktuGroup" class="filter-btn-group">
        <button type="button" class="filter-btn-option" data-value="pagi">Pagi (07-10)</button>
        <button type="button" class="filter-btn-option" data-value="siang">Siang (11-14)</button>
        <button type="button" class="filter-btn-option" data-value="sore">Sore (15-18)</button>
        <button type="button" class="filter-btn-option" data-value="malam">Malam (19-22)</button>
      </div>
    </div>
    <button class="filter-btn" id="btnApplyFilter" style="width:100%;margin-top:18px;">Terapkan Filter</button>
  </div>
</div>

  <form class="mainbareng-form" id="formCreateMabar" autocomplete="off" style="display: none; margin-top: 60px;">
  <!-- STEP 1 -->
  <div id="step1">
    <label>Judul Event
      <input type="text" name="title" required placeholder="Contoh: Futsal Minggu Pagi" />
    </label>
    <label>Cabang Olahraga
      <select name="sport" required>
        <option value="">Pilih olahraga</option>
        <option value="Sepak Bola">Sepak Bola</option>
        <option value="Futsal">Futsal</option>
        <option value="Badminton">Badminton</option>
        <option value="Basket">Basket</option>
        <option value="Tenis Meja">Tenis Meja</option>
        <option value="Billiard">Billiard</option>
        <option value="Volley">Volley</option>
      </select>
    </label>
    <label>Range Skill Minimum
      <input type="range" name="min_skill" min="1" max="5" value="1" id="minSkillRange" class="skill-range"
        oninput="updateSkillBar(this, 'minSkillValue')" />
      <span id="minSkillValue" class="skill-label">Newbie</span>
    </label>
    <label>Range Skill Maksimum
      <input type="range" name="max_skill" min="1" max="5" value="5" id="maxSkillRange" class="skill-range"
        oninput="updateSkillBar(this, 'maxSkillValue')" />
      <span id="maxSkillValue" class="skill-label">Pro</span>
    </label>
    <div class="form-actions" style="display: flex; justify-content: space-between; align-items: center;">
      <button type="button" id="btn-kembali" class="btn-cancel" style="margin-left: 220px;">Batal</>
      <button type="button" id="btnNextStep" class="btn-create-event">Lanjut</button>
    </div>
  </div>
  <!-- STEP 2 -->
  <div id="step2" style="display:none;">
    <label>Tanggal & Waktu Event
      <input type="datetime-local" name="datetime" required />
    </label>
    <label>Durasi (jam)
      <input type="number" name="duration_hours" min="1" max="12" required placeholder="Contoh: 2" />
    </label>
    <label>Deskripsi Event
      <textarea name="description" required placeholder="Ceritakan tentang event, aturan, fasilitas, dll"></textarea>
    </label>
    <label>Lokasi
      <textarea name="location" required placeholder="Detail lengkap alamat mabar"></textarea>
    </label>
    <label>Kuota
      <input type="number" name="quota" min="2" max="50" required placeholder="Contoh: 10" />
    </label>
    <label>Harga per Peserta (Rp)
      <input type="number" name="price_per_participant" min="0" required placeholder="Contoh: 40000" />
    </label>
    <label>Metode Pembayaran
      <select name="paymentMethod" required>
        <option value="online_tunai">Online & Tunai</option>
        <option value="online">Online</option>
        <option value="tunai">Tunai</option>
      </select>
    </label>
    <div class="form-actions" style="display: flex; justify-content: space-between; align-items: center;">
      <button type="button" id="btnPrevStep2" class="btn-kembali-step2" style="margin-left: 200px;">Kembali</button>
      <button type="submit" class="btn-create-event-step2">Buat Event</button>
    </div>
  </div>
</form>

<!-- Modal Event Berhasil -->
<div id="eventSuccessModal" style="display:none;position:fixed;z-index:9999;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.3);align-items:center;justify-content:center;">
  <div style="background:#fff;padding:32px 24px;border-radius:12px;box-shadow:0 2px 16px rgba(0,0,0,0.12);text-align:center;max-width:320px;">
    <h3>Event Berhasil Dibuat!</h3>
    <p>Event main bareng kamu sudah tercatat.</p>
    <button id="btnEventOk" style="margin-top:18px;padding:10px 32px;border-radius:6px;background:#2563eb;color:#fff;border:none;">OK</button>
  </div>
</div>

<!-- Modal Pilih Skill -->
<div id="skillModal" style="display:none;position:fixed;z-index:9999;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.3);align-items:center;justify-content:center;">
  <div style="background:#fff;padding:0 0 24px 0;border-radius:16px;box-shadow:0 2px 16px rgba(0,0,0,0.12);text-align:left;max-width:340px;width:94vw;">
    <div style="padding:20px 24px 0 24px;border-bottom:1px solid #eee;display:flex;align-items:center;gap:10px;">
      <span style="font-size:1.3em;cursor:pointer;" onclick="closeSkillModal()">&larr;</span>
      <h3 style="font-size:1.1em;font-weight:600;margin:0;">Tentukan Skillmu</h3>
    </div>
    <form id="skillForm" style="padding:12px 24px 0 24px;">
      <div class="skill-option" data-value="newbie">
        <span>Newbie</span>
        <input type="radio" name="skill" value="newbie" style="float:right;" />
      </div>
      <div class="skill-option" data-value="beginner">
        <span>Beginner</span>
        <input type="radio" name="skill" value="beginner" style="float:right;" />
      </div>
      <div class="skill-option" data-value="intermediate">
        <span>Intermediate</span>
        <input type="radio" name="skill" value="intermediate" style="float:right;" />
      </div>
      <div class="skill-option" data-value="advance">
        <span>Advanced</span>
        <input type="radio" name="skill" value="advance" style="float:right;" />
      </div>
      <div class="skill-option" data-value="pro">
        <span>Pro</span>
        <input type="radio" name="skill" value="pro" style="float:right;" />
      </div>
      <button id="btnSkillOk" type="submit" style="width:100%;margin-top:22px;padding:12px 0;border-radius:8px;background:#eee;color:#aaa;border:none;font-weight:600;font-size:1.08rem;cursor:not-allowed;" disabled>Konfirmasi</button>
    </form>
  </div>
</div>

<div id="notifLogin" style="display:none;position:fixed;top:40px;left:50%;transform:translateX(-50%);background:#fff3cd;color:#856404;padding:18px 32px;border-radius:8px;box-shadow:0 2px 12px rgba(0,0,0,0.18);z-index:10001;font-size:1.1rem;">
  <span>Anda harus login terlebih dahulu sebelum melakukan booking.</span>
  <button id="notifLoginClose" style="margin-left:24px;background:#ffe8a1;border:none;padding:6px 18px;border-radius:6px;cursor:pointer;">Tutup</button>
</div>

<footer>
  &copy; 2025 FullTeam - Main Bareng Listing. All rights reserved.
</footer>

<script>
let mainbarengStatusFilter = 'all';

function setLastSection(section) {
  if (section === 'mainbareng') {
    localStorage.setItem('lastSection', section);
  }
}

function getLastSection() {
  return localStorage.getItem('lastSection') || 'mainbareng';
}

function goToLastSection() {
  // Sembunyikan semua section utama
  document.getElementById('profilePage').style.display = 'none';
  document.getElementById('dashboardPage').style.display = 'none';

  document.getElementById('mainBarengSection').style.display = 'none';
  document.getElementById('formCreateMabar').style.display = 'none';
  document.querySelector('main').style.display = '';

const section = getLastSection();
  document.getElementById('mainBarengSection').style.display = '';
  document.getElementById('mainbarengGrid').style.display = '';
  const detail = document.getElementById('mainbarengDetailContainer');
  if (detail) detail.style.display = 'none';
  fetchAndRenderMainBareng();
}

  // modal pop up
  function showAuthModal(type) {
  const modal = document.getElementById('authModal');
  const body = document.getElementById('authModalBody');
  if (type === 'login') {
    body.innerHTML = `
      <h2>Masuk</h2>
      <form id="loginForm" autocomplete="off">
        <input type="email" placeholder="Email" required />
        <input type="password" placeholder="Password" required />
        <button type="submit">Masuk</button>
        <div class="auth-switch">
          Belum punya akun? <a onclick="showAuthModal('register')">Daftar</a><br>
          <a onclick="showAuthModal('forgot')">Lupa password?</a>
        </div>
      </form>
    `;
  } else if (type === 'register') {
    body.innerHTML = `
      <h2>Daftar</h2>
      <form id="registerForm" autocomplete="off">
        <input type="text" placeholder="Nama Lengkap" required />
        <input type="text" placeholder="Username" required />
        <input type="text" placeholder="No Ponsel" required />
        <input type="email" placeholder="Email" required />
        <input type="password" placeholder="Password" required />
        <input type="password" placeholder="Ulangi Password" required />
        <button type="submit">Daftar</button>
        <div class="auth-switch">
          Sudah punya akun? <a onclick="showAuthModal('login')">Masuk</a>
        </div>
      </form>
    `;
  } else if (type === 'forgot') {
    body.innerHTML = `
      <h2>Lupa Password</h2>
      <form id="forgotForm" autocomplete="off">
        <input type="email" placeholder="Email" required />
        <button type="submit">Kirim</button>
        <div class="auth-switch">
          <a onclick="showAuthModal('login')">Kembali ke Masuk</a>
        </div>
      </form>
    `;
  }
  modal.style.display = 'flex';
}

// register user ke database
document.addEventListener('submit', function(e) {
  if (e.target && e.target.id === 'registerForm') {
    e.preventDefault();
    const nama = e.target.querySelector('input[placeholder="Nama Lengkap"]').value.trim();
    const username = e.target.querySelector('input[placeholder="Username"]').value.trim();
    const ponsel = e.target.querySelector('input[placeholder="No Ponsel"]').value.trim();
    const email = e.target.querySelector('input[type="email"]').value.trim().toLowerCase();
    const password = e.target.querySelectorAll('input[type="password"]')[0].value;
    const password2 = e.target.querySelectorAll('input[type="password"]')[1].value;

    if (password !== password2) {
      alert('Password tidak sama!');
      return;
    }

    // Kirim data ke backend (MySQL)
    fetch('http://localhost:3000/api/register', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ nama, username, ponsel, email, password })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert('Pendaftaran berhasil! Silakan login.');
        showAuthModal('login');
      } else {
        alert(data.message || 'Pendaftaran gagal!');
      }
    })
    .catch(() => alert('Terjadi kesalahan, coba lagi.'));
  }
});

// validasi login
document.addEventListener('submit', function(e) {
  if (e.target && e.target.id === 'loginForm') {
    e.preventDefault();
    const email = e.target.querySelector('input[type="email"]').value.trim().toLowerCase();
    const password = e.target.querySelector('input[type="password"]').value;

    fetch('http://localhost:3000/api/login', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ email, password })
    })
    .then(res => res.json())
    .then(data => {
      console.log('Login response:', data);
      if (data.success) {
        localStorage.setItem('isLoggedIn', 'true');
        localStorage.setItem('userEmail', data.user.email);
        localStorage.setItem('userId', data.user.id);
        updateAuthUI();
        document.getElementById('authModal').style.display = 'none';
      } else {
        alert('Email atau password salah!');
      }
    });
  }
});

function isLoggedIn() {
  return localStorage.getItem('isLoggedIn') === 'true';
}

// Tutup modal
document.getElementById('authModalClose').onclick = function() {
  document.getElementById('authModal').style.display = 'none';
};
window.addEventListener('click', function(e) {
  const modal = document.getElementById('authModal');
  if (e.target === modal) modal.style.display = 'none';
});

// Event tombol header
document.querySelector('.btn-masuk').onclick = () => showAuthModal('login');
document.querySelector('.btn-daftar').onclick = () => showAuthModal('register');

// Update UI based on login state
function updateAuthUI() {
  const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
  document.querySelector('.btn-masuk').style.display = isLoggedIn ? 'none' : '';
  document.querySelector('.btn-daftar').style.display = isLoggedIn ? 'none' : '';
  document.querySelector('.btn-profile').style.display = isLoggedIn ? '' : 'none';
  document.getElementById('profileDropdown').style.display = 'none';

  document.getElementById('btnAddMabarProfile').style.display = 'none';
  document.querySelector('.eventku-dropdown').style.display = isLoggedIn ? '' : 'none';
}

// Panggil fungsi ini setelah login/logout dan saat halaman dimuat
updateAuthUI();

const btnEventDropdown = document.getElementById('btnEventDropdown');
const eventDropdownMenu = document.getElementById('eventDropdownMenu');
btnEventDropdown.onclick = function(e) {
  e.stopPropagation();
  dropdown.style.display = 'none';
  eventDropdownMenu.style.display = eventDropdownMenu.style.display === 'none' ? 'block' : 'none';
};
document.addEventListener('click', function(e) {
  if (!eventDropdownMenu.contains(e.target) && e.target !== btnEventDropdown) {
    eventDropdownMenu.style.display = 'none';
  }
});

document.getElementById('btnEventku').onclick = function() {
  eventDropdownMenu.style.display = 'none';
  showEventkuPage();
};

document.querySelector('.btn-profile').onclick = function() {
  if (confirm('Logout?')) {
    localStorage.removeItem('isLoggedIn');
    updateAuthUI();
  }
};

const btnProfile = document.querySelector('.btn-profile');
const dropdown = document.getElementById('profileDropdown');

// Toggle dropdown saat klik ikon profil
btnProfile.onclick = function(e) {
  e.stopPropagation();
  eventDropdownMenu.style.display = 'none';
  dropdown.style.display = dropdown.style.display === 'none' ? 'flex' : 'none';
};

// Tutup dropdown jika klik di luar
document.addEventListener('click', function(e) {
  if (!dropdown.contains(e.target) && e.target !== btnProfile) {
    dropdown.style.display = 'none';
  }
});

// Logout
document.getElementById('btnLogout').onclick = function() {
  dropdown.style.display = 'none';
  localStorage.removeItem('isLoggedIn');
  localStorage.removeItem('userEmail');
  dropdown.style.display = 'none';
  updateAuthUI();
};

const filterModal = document.getElementById('filterModal');
const btnOpenFilterModal = document.getElementById('btnOpenFilterModal');
const btnApplyFilter = document.getElementById('btnApplyFilter');
const filterModalClose = document.getElementById('filterModalClose');

btnOpenFilterModal.onclick = () => {
  filterModal.style.display = 'flex';
};
filterModalClose.onclick = () => {
  filterModal.style.display = 'none';
};
window.onclick = function(event) {
  if (event.target === filterModal) filterModal.style.display = 'none';
};

document.getElementById('btnNextStep').onclick = function() {
  // Validasi step 1
  const form = document.getElementById('formCreateMabar');
  if (!form.title.value || !form.sport.value) {
    alert('Isi semua data pada step 1!');
    return;
  }
  document.getElementById('step1').style.display = 'none';
  document.getElementById('step2').style.display = '';
};

document.getElementById('btnPrevStep2').onclick = function() {
  document.getElementById('step2').style.display = 'none';
  document.getElementById('step1').style.display = '';
};

function hideAllSections() {
  document.getElementById('profilePage').style.display = 'none';
  document.getElementById('dashboardPage').style.display = 'none';
  document.getElementById('mainBarengSection').style.display = 'none';
  document.getElementById('formCreateMabar').style.display = 'none';
  document.getElementById('eventkuPage').style.display = 'none';
  document.querySelector('main').style.display = 'none';
}

document.getElementById('btnAddMabarProfile').onclick = function() {
  document.getElementById('profilePage').style.display = 'none';
  document.getElementById('dashboardPage').style.display = 'none';
  document.getElementById('mainBarengSection').style.display = 'none';
  document.querySelector('main').style.display = '';

  // Simpan section terakhir sebelum create event
  if (document.getElementById('mainBarengSection').style.display !== 'none') {
    setLastSection('mainbareng');
    resetFormCreateMabar(); 
    document.getElementById('formCreateMabar').style.display = '';
    window.scrollTo({top: 0, behavior: 'smooth'});
};
}

document.querySelector('.btn-cancel').onclick = function(e) {
  e.preventDefault();
  document.getElementById('formCreateMabar').style.display = 'none';
  document.getElementById('mainBarengSection').style.display = '';
  document.querySelector('main').style.display = '';
  document.getElementById('mainbarengGrid').style.display = '';
  document.getElementById('mainbarengCount').style.display = '';
  document.getElementById('mainbarengDetailContainer').style.display = 'none';
  const filterRow = document.querySelector('.mainbareng-filter-row');
  if (filterRow) filterRow.style.display = 'flex';

  // Refresh list
  fetchAndRenderMainBareng();
};

function showDashboardPage() {
  hideAllSections();
  document.getElementById('dashboardPage').style.display = '';

  const userId = localStorage.getItem('userId');
  if (!userId) {
    alert('Anda harus login untuk melihat dashboard.');
    return;
  }

  fetchAndRenderDashboardMainbareng();
}

async function fetchAndRenderDashboardMainbareng() {
  const userId = localStorage.getItem('userId');
  if (!userId) return;

  const res = await fetch(`http://localhost:3000/api/mainbareng/user/${userId}`);
  const result = await res.json();
  const now = new Date();

  window.dashboardEventsData = (result.data || []).filter(item => {
    if (mainbarengStatusFilter !== 'all' && item.participant_status !== mainbarengStatusFilter) {
      return false;
    }
    return true;
  });

  filterDashboardEvents();
}

async function showEventkuPage() {
  hideAllSections();
  document.getElementById('eventkuPage').style.display = '';

  // Ambil userId
  const userId = localStorage.getItem('userId');
  if (!userId) {
    alert('Anda harus login untuk melihat event Anda.');
    return;
  }

  // Ambil event yang dibuat user atau diikuti user
  const res = await fetch('http://localhost:3000/api/mainbareng');
  const result = await res.json();
  const myEvents = (result.data || []).filter(event =>
    String(event.host_id) === String(userId) ||
    (event.participants && event.participants.includes(userId))
  );

  const container = document.getElementById('eventkuList');
  container.innerHTML = '';

  if (!myEvents.length) {
    container.innerHTML = '<p style="text-align:center;margin-top:40px;">Kamu belum mengikuti event apapun.</p>';
    return;
  }

  const now = new Date();

  container.innerHTML = myEvents.map(event => {
    const startDate = new Date(event.datetime);
    const duration = Number(event.duration_hours) || 2;
    const endDate = new Date(startDate.getTime() + duration * 60 * 60 * 1000);

    let isFinished = false;
    if (typeof event.finished !== 'undefined') {
      isFinished = !!event.finished;
    } else {
      isFinished = now > endDate;
    }

    const isHost = String(event.host_id) === String(userId);
    const canMarkFinished = isHost && !isFinished && now >= endDate;

    const status = isFinished ? 'Selesai' : 'Belum Selesai';
    const statusColor = isFinished ? '#43a047' : '#b71c1c';

    const formatTime = d => d.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}).replace(':', '.');
    const timeRange = `${formatTime(startDate)} - ${formatTime(endDate)}`;
    const tanggalLengkap = `${startDate.toLocaleDateString('id-ID', {weekday:'short', day:'2-digit', month:'short', year:'numeric'})} ${timeRange}`;

    return `
      <div style="display:flex;justify-content:space-between;align-items:center;padding:14px 0;border-bottom:1px solid #eee;">
        <div>
          <div style="font-weight:600;font-size:1.08rem;">${event.title}</div>
          <div style="color:#666;font-size:0.98rem;">${tanggalLengkap}</div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;">
          <span style="font-size:1rem;font-weight:500;margin-left:24px;color:${statusColor};background:none;padding:0;">${status}</span>
          ${canMarkFinished ? `<button class="btn-mark-finished" data-id="${event.id}" style="margin-top:8px;padding:6px 18px;border-radius:6px;background:#43a047;color:#fff;border:none;font-size:0.98rem;cursor:pointer;">Tandai Selesai</button>` : ''}
        </div>
      </div>
    `;
  }).join('');

  // Event listener untuk tombol "Tandai Selesai"
  container.querySelectorAll('.btn-mark-finished').forEach(btn => {
    btn.onclick = async function() {
      const eventId = this.getAttribute('data-id');
      await fetch(`http://localhost:3000/api/mainbareng/${eventId}/finish`, { method: 'POST' });
      alert('Event ditandai selesai!');
      showEventkuPage(); // refresh
    };
  });

  const statusLabel = document.getElementById('eventkuStatusLabel');
  statusLabel.style.textAlign = 'center';
  statusLabel.style.display = '';
}

// Profile
document.getElementById('btnProfile').onclick = function() {
  dropdown.style.display = 'none';
  hideAllSections();
  document.getElementById('formCreateMabar').style.display = 'none';
  document.getElementById('profilePage').style.display = '';

  // Ambil email user dari localStorage (atau session/cookie)
  const email = localStorage.getItem('userEmail');
  if (!email) {
    alert('User tidak ditemukan!');
    return;
  }

  fetch('http://localhost:3000/api/profile', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ email })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      document.getElementById('editNama').value = data.user.nama || '';
      document.getElementById('editUsername').value = data.user.username || '';
      document.getElementById('editPonsel').value = data.user.ponsel || '';
      document.getElementById('editEmail').value = data.user.email || '';
    } else {
      alert('Gagal mengambil data diri');
    }
  });
}

// Prefill data user ke form
function showEditProfile(user) {
  document.getElementById('editNama').value = user.nama || '';
  document.getElementById('editUsername').value = user.username || '';
  document.getElementById('editPonsel').value = user.ponsel || '';
  document.getElementById('editEmail').value = user.email || '';
  document.getElementById('editProfileForm').style.display = '';
}

// Submit perubahan data diri
document.getElementById('editProfileForm').onsubmit = function(e) {
  e.preventDefault();
  const data = {
    nama: document.getElementById('editNama').value,
    username: document.getElementById('editUsername').value,
    ponsel: document.getElementById('editPonsel').value,
    email: document.getElementById('editEmail').value
  };
  fetch('http://localhost:3000/api/profile/update', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data)
  })
  .then(res => res.json())
  .then(res => {
    alert(res.success ? 'Data berhasil diubah!' : (res.message || 'Gagal mengubah data'));
  });
};

document.getElementById('btnGoBackProfile').onclick = function() {
  goToLastSection();
};

document.getElementById('btnDashboard').onclick = function() {
  dropdown.style.display = 'none'; 
  hideAllSections();

  document.getElementById('formCreateMabar').style.display = 'none';
  document.getElementById('dashboardPage').style.display = '';
  document.getElementById('profilePage').style.display = 'none';
  document.querySelector('main').style.display = 'none';
  document.getElementById('mainbarengGrid').style.display = '';
  dropdown.style.display = 'none';

  fetchAndRenderDashboardMainbareng();
}

function filterDashboardEvents() {
  const name = document.getElementById('searchEventName').value.toLowerCase();
  const date = document.getElementById('searchEventDate').value;
  const cabor = selectedCabor;
  const status = mainbarengStatusFilter;

  let filtered = (window.dashboardEventsData || []).filter(ev => {
    // Filter judul
    const matchName = !name || ev.title.toLowerCase().includes(name);
    // Filter tanggal
    const matchDate = !date || ev.datetime.startsWith(date);
    // Filter cabor
    const matchCabor = !cabor || ev.sport === cabor;
    // Filter status
    if (status !== 'all' && ev.participant_status !== status) return false;
    return matchName && matchDate && matchCabor;
  });

  renderMainBarengList(filtered);
}

// Event listener
document.getElementById('searchEventName').addEventListener('input', filterDashboardEvents);
document.getElementById('searchEventDate').addEventListener('change', filterDashboardEvents);

const btn = document.getElementById('dropdownCaborBtn');
const list = document.getElementById('dropdownCaborList');
const label = document.getElementById('dropdownCaborLabel');
let selectedCabor = '';

btn.onclick = function(e) {
  e.stopPropagation();
  list.style.display = list.style.display === 'block' ? 'none' : 'block';
};

document.querySelectorAll('.dropdown-cabor-item').forEach(item => {
  item.onclick = function(e) {
    e.stopPropagation();
    selectedCabor = this.getAttribute('data-value');
    label.textContent = this.textContent;
    document.querySelectorAll('.dropdown-cabor-item').forEach(i => i.classList.remove('active'));
    this.classList.add('active');
    list.style.display = 'none';
    filterDashboardEvents();
  };
});

// Tutup dropdown jika klik di luar
document.addEventListener('click', function(e) {
  list.style.display = 'none';
});


document.getElementById('notifLoginClose').onclick = function() {
  document.getElementById('notifLogin').style.display = 'none';
  showAuthModal('login');
};

document.querySelectorAll('.btn-menu').forEach(btn => {
  btn.addEventListener('click', function() {
    // Hanya set jika benar-benar pindah section utama
    if (this.textContent.trim() === 'Main Bareng') {
      setLastSection('mainbareng');
      hideAllSections();
      backToMainBarengList();
      document.getElementById('mainBarengSection').style.display = '';
      fetchAndRenderMainBareng();
    }
    document.getElementById('profilePage').style.display = 'none';
    document.getElementById('dashboardPage').style.display = 'none';
    document.getElementById('eventkuPage').style.display = 'none';
    document.querySelector('main').style.display = '';
    setActiveMenu(this);
  });
});

// Gunakan lokasiIndonesia autocomplete
const mainbarengLocationInput = document.getElementById('mainbarengLocationAutocomplete');
const mainbarengSuggestionsList = document.getElementById('mainbarengLocationSuggestions');

document.querySelectorAll('#filterMetodeGroup .filter-btn-option').forEach(btn => {
  btn.onclick = function() {
    this.classList.toggle('active');
  };
});

document.querySelectorAll('#filterWaktuGroup .filter-btn-option').forEach(btn => {
  btn.onclick = function() {
    this.classList.toggle('active');
  };
});

btnApplyFilter.onclick = function() {
  window.selectedFilterMetode = Array.from(document.querySelectorAll('#filterMetodeGroup .filter-btn-option.active')).map(btn => btn.dataset.value);
  window.selectedFilterWaktu = Array.from(document.querySelectorAll('#filterWaktuGroup .filter-btn-option.active')).map(btn => btn.dataset.value);
  filterModal.style.display = 'none';
  filterMainbareng();
};

function filterMainbareng() {
  const lokasi = document.getElementById('mainbarengLocationAutocomplete').value.trim();
  window.selectedMainbarengLocation = lokasi;
  fetchAndRenderMainBareng();
}

// Sembunyikan dropdown jika klik di luar
document.addEventListener('click', function(event) {
  if (!mainbarengLocationInput.contains(event.target) && !mainbarengSuggestionsList.contains(event.target)) {
    mainbarengSuggestionsList.innerHTML = '';
  }
});

// Fungsi filter event main bareng berdasarkan lokasi
function filterMainbarengByLocation(lokasi) {
  // Simpan lokasi terpilih, lalu fetch ulang data main bareng
  window.selectedMainbarengLocation = lokasi;
  fetchAndRenderMainBareng();
}

  function skillLabel(val) {
  switch (parseInt(val)) {
    case 1: return 'Newbie';
    case 2: return 'Beginner';
    case 3: return 'Intermediate';
    case 4: return 'Advanced';
    case 5: return 'Pro';
    default: return '';
  }
}
function skillColor(val) {
  switch (parseInt(val)) {
    case 1: return '#2196f3'; // blue
    case 2: return '#4caf50'; // green
    case 3: return '#ffeb3b'; // yellow
    case 4: return '#ff9800'; // orange
    case 5: return '#f44336'; // red
    default: return '#2196f3';
  }
}
function updateSkillBar(rangeElem, labelId) {
  const val = rangeElem.value;
  document.getElementById(labelId).textContent = skillLabel(val);
  rangeElem.style.accentColor = skillColor(val);
}

// Set label dan warna awal saat halaman dimuat
document.addEventListener('DOMContentLoaded', function() {
  const minSkill = document.getElementById('minSkillRange');
  const maxSkill = document.getElementById('maxSkillRange');
  if (minSkill) updateSkillBar(minSkill, 'minSkillValue');
  if (maxSkill) updateSkillBar(maxSkill, 'maxSkillValue');
});

  let Filter = 'all';

document.getElementById('btnBuatEvent').onclick = function() {
  eventDropdownMenu.style.display = 'none';
  hideAllSections();
  document.getElementById('formCreateMabar').style.display = '';
  document.querySelector('main').style.display = 'none';
  resetFormCreateMabar();
  window.scrollTo({top: 0, behavior: 'smooth'});
};

document.querySelectorAll('.status-filter-btn').forEach(btn => {
  btn.onclick = function() {
    document.querySelectorAll('.status-filter-btn').forEach(b => {
      b.classList.remove('active');
    });
    this.classList.add('active');
    mainbarengStatusFilter = this.dataset.status || 'all';
    fetchAndRenderDashboardMainbareng();
  };
});

  async function fetchAndRenderMainBareng() {
  console.log('fetchandrenderMainBareng called');
  const res = await fetch('http://localhost:3000/api/mainbareng');
  const result = await res.json();
  const grid = document.getElementById('mainbarengGrid');

  grid.innerHTML = '';
  let data = (result && result.data) ? result.data : [];

  if (window.selectedMainbarengLocation && window.selectedMainbarengLocation.length > 0) {
    const lokasiLower = window.selectedMainbarengLocation.toLowerCase();
    data = data.filter(item =>
      (item.location || '').toLowerCase().includes(lokasiLower)
    );
  }

  if (window.selectedFilterMetode && window.selectedFilterMetode.length > 0) {
  data = data.filter(item =>
    window.selectedFilterMetode.some(val => {
      const method = (item.payment_method || item.paymentMethod || '').toLowerCase();
      if (val === 'online') return method === 'online' || method === 'online_tunai';
      if (val === 'tunai') return method === 'tunai' || method === 'online_tunai';
      return method === val.toLowerCase();
    })
  );
}

if (window.selectedFilterWaktu && window.selectedFilterWaktu.length > 0) {
  data = data.filter(item => {
    if (window.selectedFilterWaktu.includes('')) return true;
    const jam = new Date(item.datetime).getHours();
    return window.selectedFilterWaktu.some(waktu => {
      if (waktu === 'pagi') return jam >= 7 && jam <= 10;
      if (waktu === 'siang') return jam >= 11 && jam <= 14;
      if (waktu === 'sore') return jam >= 15 && jam <= 18;
      if (waktu === 'malam') return jam >= 19 && jam <= 22;
      return false;
    });
  });
}

const searchInput = document.getElementById('globalEventSearchInput');
  const searchKeyword = searchInput ? searchInput.value.trim().toLowerCase() : '';
  if (searchKeyword.length > 0) {
    data = data.filter(item =>
      (item.title || '').toLowerCase().includes(searchKeyword)
    );
  }

  if (!result.success || !data || data.length === 0) {
    grid.innerHTML = `
      <div class="mainbareng-empty-state">
        <img src="https://img.icons8.com/ios/100/cccccc/document--v1.png" width="80" alt="empty" style="margin-bottom:18px;opacity:0.5;">
        <div style="font-weight:600;font-size:1.1rem;margin-bottom:8px;">Tidak ada event main bareng saat ini.</div>
      </div>
    `;
    grid.style.display = 'flex';
    grid.style.flexDirection = 'column';
    grid.style.justifyContent = 'center';
    grid.style.alignItems = 'center';
    grid.style.minHeight = '60vh';
    document.getElementById('mainbarengCount').innerHTML = `<span style="color:#bbb;font-weight:400;">Menampilkan</span> <b>0 event mabar</b>`;
    return;
  }

grid.style.display = '';
grid.style.flexDirection = '';
grid.style.justifyContent = '';
grid.style.alignItems = '';
grid.style.minHeight = '';

  document.getElementById('mainbarengCount').innerHTML = `<span style="color:#bbb;font-weight:400;">Menampilkan</span> <b>${data.length} event mabar`;

  data.forEach(item => {
  const slotFilled = Number(item.slot_filled) || 0;
  const quota = Number(item.quota) || 0;

  let sportEmoji = '';
  let sportIconColor = '#e04bb6';
  let dateIconColor = '#6c63ff';
  let locationIconColor = '#e63946';

  switch ((item.sport || '').toLowerCase()) {
    case 'futsal': sportEmoji = 'ü•Ö'; break;
    case 'badminton': sportEmoji = 'üè∏'; break;
    case 'basket': sportEmoji = 'üèÄ'; break;
    case 'voli': sportEmoji = 'üèê'; break;
    case 'sepak bola': sportEmoji = '‚öΩ'; break;
    case 'billiard': sportEmoji = 'üé±'; break;
    case 'tenis meja': sportEmoji = 'üéæ'; break;
    default: sportEmoji = 'üèÖ';
  }

  const startDate = new Date(item.datetime);
  const duration = Number(item.duration_hours) || 2; // default 2 jam jika tidak ada
  const endDate = new Date(startDate.getTime() + duration * 60 * 60 * 1000);

  const formatTime = d => d.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}).replace(':', '.');
  const timeRange = `${formatTime(startDate)} - ${formatTime(endDate)}`;

    grid.innerHTML += `
    <div class="mainbareng-card" data-id="${item.id}">
      <div class="mainbareng-header" style="display:flex;justify-content:space-between;align-items:flex-start;">
        <div style="flex:1;">
          <strong>${item.title}</strong>
          <div style="display:flex;align-items:center;gap:8px;margin-top:2px;padding-left:0;">
            <span style="display:inline-block;width:22px;text-align:center;font-size:1.1em;color:${sportIconColor};margin-right:0px;">${sportEmoji}</span>
            <span style="color:#222;font-size:1rem;">${item.sport}</span>
            <span style="color:#222;">‚Ä¢ ${item.min_skill} - ${item.max_skill}</span>
          </div>
          <div style="display:flex;align-items:center;gap:8px;margin-top:8px;">
            <span style="display:inline-flex;align-items:center;">
              <span style="font-size:1.1em;color:${dateIconColor};margin-right:6px;">üìÖ</span>
              <span style="color:#222;">
                ${startDate.toLocaleDateString('id-ID', {weekday:'short', day:'2-digit', month:'short', year:'numeric'})}
              </span>
            </span>
            <span style="color:#222;">${timeRange}</span>
          </div>
          <div style="display:flex;align-items:center;gap:8px;margin-top:8px;">
            <span style="display:inline-flex;align-items:center;">
            <span style="font-size:1.1em;color:${locationIconColor};margin-right:6px;">üìç</span>
            <span>${detectWilayah(item.location)}</span>
            </span>
          </div>
        </div>
        <div class="mainbareng-quota" style="margin-left:16px;">
          <span class="badge booked" style="background:#43a047;color:#fff;font-weight:700;font-size:1rem;padding:4px 12px;">
            ${slotFilled}/${quota} orang
          </span>
        </div>
      </div>
      <div class="mainbareng-host" style="margin-top:12px;">
        Host: <b>${item.host_username || '-'}</b>
      </div>
    </div>
    `;
  });

  document.querySelectorAll('.mainbareng-card').forEach(card => {
    card.addEventListener('click', function(e) {
      if (e.target.classList.contains('btn-create-event')) return;
      const id = this.getAttribute('data-id');
      if (!id) return;
      showMainBarengDetail(id);
    });
  });
}

function renderMainBarengList(list) {
  const container = document.getElementById('dashboardMainbarengGrid');
  container.innerHTML = '';

  if (!list.length) {
    container.innerHTML = `
      <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;margin-top:40px;">
        <img src="https://img.icons8.com/ios/100/cccccc/document--v1.png" width="80" alt="empty" style="margin-bottom:18px;opacity:0.5;">
        <div style="font-weight:600;font-size:1.1rem;margin-bottom:8px;">Belum ada Main bareng</div>
      </div>
    `;
    return;
  }

  list.forEach(item => {
    const startDate = new Date(item.datetime);
    const duration = Number(item.duration_hours) || 2;
    const endDate = new Date(startDate.getTime() + duration * 60 * 60 * 1000);
    const formatTime = d => d.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}).replace(':', '.');
    const timeRange = `${formatTime(startDate)} - ${formatTime(endDate)}`;
    const tanggalLengkap = `${startDate.toLocaleDateString('id-ID', {weekday:'short', day:'2-digit', month:'short', year:'numeric'})} ${timeRange}`;

    let sportEmoji = '';
    switch ((item.sport || '').toLowerCase()) {
      case 'futsal': sportEmoji = 'ü•Ö'; break;
      case 'badminton': sportEmoji = 'üè∏'; break;
      case 'basket': sportEmoji = 'üèÄ'; break;
      case 'voli': sportEmoji = 'üèê'; break;
      case 'sepak bola': sportEmoji = '‚öΩ'; break;
      case 'billiard': sportEmoji = 'üé±'; break;
      case 'tenis meja': sportEmoji = 'üéæ'; break;
      default: sportEmoji = 'üèÖ';
    }

    container.innerHTML = `
    <ul style="list-style:none;padding:0;margin:0;">
      ${list.map(item => {
        const startDate = new Date(item.datetime);
        const duration = Number(item.duration_hours) || 2;
        const endDate = new Date(startDate.getTime() + duration * 60 * 60 * 1000);
        const formatTime = d => d.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}).replace(':', '.');
        const timeRange = `${formatTime(startDate)} - ${formatTime(endDate)}`;
        const tanggalLengkap = `${startDate.toLocaleDateString('id-ID', {weekday:'short', day:'2-digit', month:'short', year:'numeric'})} ${timeRange}`;
        // Tambahkan jenis olahraga di atas tanggal
        return `
          <li style="padding:14px 0;border-bottom:1px solid #eee;cursor:pointer;" data-id="${item.id}">
            <div style="font-weight:600;font-size:1.08rem;">${item.title}</div>
            <div style="display:flex;justify-content:space-between;align-items:center;color:#666;font-size:0.98rem;">
              <span>${tanggalLengkap}</span>
              <span style="font-weight:600;color:#333;margin-left:32px;min-width:100px;text-align:right;">${item.sport}</span>
            </div>
          </li>
        `;
      }).join('')}
    </ul>
  `;

  container.querySelectorAll('li[data-id]').forEach(li => {
    li.addEventListener('click', function() {
      const id = this.getAttribute('data-id');
      if (!id) return;
      showMainBarengDetail(id);
    });
  });
  });
}

function showMainBarengDetail(id) {
  document.getElementById('mainbarengGrid').style.display = 'none';
  document.getElementById('mainbarengCount').style.display = 'none';
  document.querySelector('.mainbareng-filter-row').style.display = 'none';

  const detailContainer = document.getElementById('mainbarengDetailContainer');
  detailContainer.style.display = '';
  detailContainer.innerHTML = '<p>Memuat...</p>';

  fetch(`http://localhost:3000/api/mainbareng/${id}`)
    .then(res => res.json())
    .then(result => {
      if (!result.success) {
        detailContainer.innerHTML = '<p>Event tidak ditemukan.</p>';
        return;
      }

      const item = result.data;
      const hargaPerPeserta = item.price_per_participant || 0;
      const metodePembayaran = labelMetodePembayaran(item.payment_method);
      const quota = Number(item.quota) || 0;
      const slotFilled = Number(item.slot_filled) || 0;
      const slotTersisa = Math.max(quota - slotFilled, 0);

      let metodeButtons = '';
      if (item.payment_method == 'online_tunai') {
    // Online & Tunai
    metodeButtons = `
      <button type="button" class="btn-metode-pembayaran" id="btnOnline" style="border:1.5px solid #b71c1c;background:#fff;color:#b71c1c;padding:6px 18px;border-radius:6px;font-weight:500;">Online</button>
      <button type="button" class="btn-metode-pembayaran" id="btnTunai" style="border:1.5px solid #bbb;background:#fff;color:#222;padding:6px 18px;border-radius:6px;font-weight:500;">Tunai</button>
    `;
  } else if (item.payment_method == 'online') {
    // Online saja
    metodeButtons = `
      <button type="button" class="btn-metode-pembayaran" id="btnOnline" style="border:1.5px solid #b71c1c;background:#fff;color:#b71c1c;padding:6px 18px;border-radius:6px;font-weight:500;">Online</button>
    `;
  } else if (item.payment_method == 'tunai') {
    // Tunai saja
    metodeButtons = `
      <button type="button" class="btn-metode-pembayaran" id="btnTunai" style="border:1.5px solid #b71c1c;background:#fff;color:#b71c1c;padding:6px 18px;border-radius:6px;font-weight:500;">Tunai</button>
    `;
  }

  if (item.host_id == localStorage.getItem('userId')) {
    // Sembunyikan tombol gabung host
  } else {
    // tampilkan tombol gabung
  }

      const startDate = new Date(item.datetime);
      const duration = Number(item.duration_hours) || 2;
      const endDate = new Date(startDate.getTime() + duration * 60 * 60 * 1000);
      const formatTime = d => d.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}).replace(':', '.');
      const timeRange = `${formatTime(startDate)} - ${formatTime(endDate)}`;
      const tanggalLengkap = `${startDate.toLocaleDateString('id-ID', {weekday:'short', day:'2-digit', month:'short', year:'numeric'})} ${timeRange}`;

      detailContainer.innerHTML = `
      <div class="mainbareng-detail-layout">
    <div class="mainbareng-detail-main">
      <h1 style="font-size:2rem;margin-bottom:18px;">${item.title}</h1>
      <div style="margin-bottom:18px;">
        <b>${item.sport}</b> &nbsp;‚Ä¢&nbsp; ${item.min_skill} - ${item.max_skill}
      </div>
      <section class="mainbareng-detail-section" style="margin-bottom:32px;">
        <h2 style="font-size:1.3rem;color:#b71c1c;margin-bottom:8px;display:flex;align-items:center;">
          Tentang Mabar
        </h2>
        <div class="mainbareng-detail-desc" style="margin-left:0;">
          ${item.description ? item.description.replace(/\n/g, '<br>') : '<i>Belum ada deskripsi.</i>'}
        </div>
      </section>
      <section class="mainbareng-detail-section">
        <h2 style="font-size:1.3rem;color:#b71c1c;margin-bottom:8px;display:flex;align-items:center;">Lokasi</h2>
        <div class="mainbareng-detail-location" style="margin-left:0px;">
          ${item.location}
        </div>
      </section>
    </div>
    <aside class="mainbareng-detail-aside">
      <div class="mainbareng-card-mabar">
        <h3>Info Event</h3>
        <div class="mainbareng-detail-info">
          <div style="margin-bottom:18px;">
            <b>Metode Pembayaran</b><br>
            <span>${metodePembayaran}</span>
          </div>
          <div style="margin-bottom:18px;">
            <b>Waktu & Tanggal</b><br>
            <span>${tanggalLengkap}</span>
          </div>
          <div style="margin-bottom:18px;">
            <b>Host</b><br>
            <span>${item.host_username || '-'}</span>
          </div>
          <!-- Pindahkan bagian ini ke bawah host -->
          <div style="margin-bottom:18px;">
            <b>Pilih metode pembayaran:</b><br>
            <div style="display:flex;gap:8px;margin:8px 0 12px 0;">
              ${metodeButtons}
            </div>
          </div>
          <div style="margin-bottom:18px;">
            <span style="font-size:1.5rem;font-weight:600;color:#222;">Rp${hargaPerPeserta.toLocaleString('id-ID')}</span>
            <span style="color:#888;font-size:1rem;">/peserta</span>
          </div>
          <div style="margin-bottom:10px;">
            <span style="color:#d32f2f;font-size:1rem;">Tersisa ${slotTersisa} slot!</span>
          </div>
          <div style="margin-top:28px;">
            <button class="btn-gabung-mabar" onclick="gabungMainBareng(${item.id})" style="width:100%;padding:12px 0;background:#b71c1c;color:#fff;font-weight:600;border:none;border-radius:8px;font-size:1.08rem;cursor:pointer;">Gabung Main Bareng</button>
          </div>
        </div>
      </div>
    </aside>
  </div>
      `;
    });

    setTimeout(() => {
        const btnOnline = document.getElementById('btnOnline');
        const btnTunai = document.getElementById('btnTunai');
        if (btnOnline && btnTunai) {
          btnOnline.onclick = () => {
            btnOnline.style.borderColor = '#b71c1c';
            btnOnline.style.color = '#b71c1c';
            btnTunai.style.borderColor = '#bbb';
            btnTunai.style.color = '#222';
          };
          btnTunai.onclick = () => {
            btnTunai.style.borderColor = '#b71c1c';
            btnTunai.style.color = '#b71c1c';
            btnOnline.style.borderColor = '#bbb';
            btnOnline.style.color = '#222';
          };
        }
      }, 100);
}

function labelMetodePembayaran(val) {
  switch (val) {
    case 'online_tunai': return 'Online & Tunai';
    case 'online': return 'Online';
    case 'tunai': return 'Tunai';
    default: return '-';
  }
}

function gabungMainBareng(eventId) {
  const userId = localStorage.getItem('userId');
  console.log('Gabung event:', { eventId, userId });
  if (!userId) {
    alert('Anda harus login untuk join event.');
    return;
  }

  showSkillModal(eventId, userId);
}

function showSkillModal(eventId, userId) {
  const modal = document.getElementById('skillModal');
  modal.style.display = 'flex';

  // Reset
  document.querySelectorAll('.skill-option').forEach(opt => opt.classList.remove('selected'));
  document.querySelectorAll('input[name="skill"]').forEach(r => r.checked = false);
  const btn = document.getElementById('btnSkillOk');
  btn.disabled = true;
  btn.style.background = '#eee';
  btn.style.color = '#aaa';
  btn.style.cursor = 'not-allowed';

  // Pilih skill
  document.querySelectorAll('.skill-option').forEach(opt => {
    opt.onclick = function() {
      document.querySelectorAll('.skill-option').forEach(o => o.classList.remove('selected'));
      this.classList.add('selected');
      this.querySelector('input[type="radio"]').checked = true;
      btn.disabled = false;
      btn.style.background = '#2563eb';
      btn.style.color = '#fff';
      btn.style.cursor = 'pointer';
    };
  });

  // Submit
  document.getElementById('skillForm').onsubmit = function(e) {
    e.preventDefault();
    const skill = document.querySelector('input[name="skill"]:checked');
    if (!skill) return;
    btn.disabled = true;
    btn.textContent = 'Memproses...';
    fetch(`http://localhost:3000/api/mainbareng/${eventId}/join`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ user_id: userId, skill: skill.value })
    })
    .then(res => res.json())
    .then(result => {
      alert(result.message || (result.success ? 'Berhasil join event!' : 'Gagal join event'));
      modal.style.display = 'none';
      btn.textContent = 'Konfirmasi';
      showMainBarengDetail(eventId);
    })
    .catch(() => {
      btn.disabled = false;
      btn.textContent = 'Konfirmasi';
    });
  };
}

function closeSkillModal() {
  document.getElementById('skillModal').style.display = 'none';
}

function backToMainBarengList() {
  document.getElementById('mainbarengDetailContainer').style.display = 'none';
  document.getElementById('mainbarengGrid').style.display = '';
  document.getElementById('mainbarengCount').style.display = '';

  const filterRow = document.querySelector('.mainbareng-filter-row');
  if (filterRow) {
    filterRow.style.display = 'flex';
    filterRow.style.justifyContent = 'flex-end';
    filterRow.style.alignItems = 'center';
    filterRow.style.marginBottom = '24px';
    filterRow.style.gap = '12px';
    filterRow.style.marginTop = '100px';
  }
}

document.getElementById('formCreateMabar').onsubmit = async function(e) {
  e.preventDefault();

  const userId = localStorage.getItem('userId');
  if (!userId) {
    alert('Anda harus login untuk membuat event.');
    return;
  }

  const form = e.target;
  const data = {
    title: form.title.value,
    sport: form.sport.value,
    min_skill: form.min_skill.value,
    max_skill: form.max_skill.value,
    datetime: form.datetime.value,
    location: form.location.value,
    quota: form.quota.value,
    host_id: userId,
    payment_method: form.paymentMethod.value,
    description: form.description.value,
    price_per_participant: form.price_per_participant.value,
    duration_hours: form.duration_hours.value
  };
  console.log(form.title, form.title.value);

  const res = await fetch('http://localhost:3000/api/mainbareng/create', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data)
  });

  const result = await res.json();
  if (result.success) {
    document.getElementById('formCreateMabar').style.display = 'none';
    document.getElementById('mainBarengSection').style.display = '';
    document.getElementById('mainbarengDetailContainer').style.display = 'none';
    document.getElementById('mainbarengGrid').style.display = '';
    
    const filterRow = document.querySelector('.mainbareng-filter-row');
    filterRow.style.display = 'flex';
    filterRow.style.justifyContent = 'flex-end';
    filterRow.style.alignItems = 'center';
    filterRow.style.marginBottom = '24px';
    filterRow.style.gap = '12px';
    filterRow.style.marginTop = '100px';
    document.getElementById('mainbarengCount').style.display = '';

    fetchAndRenderMainBareng(); // refresh list
    document.getElementById('eventSuccessModal').style.display = 'flex';
  } else {
    alert(result.message || 'Gagal membuat event');
  }
};

document.getElementById('btnEventOk').onclick = function() {
  document.getElementById('eventSuccessModal').style.display = 'none';
  goToLastSection();
};

function resetFormCreateMabar() {
  const form = document.getElementById('formCreateMabar');
  form.reset();

  // Tampilkan step 1, sembunyikan step 2
  document.getElementById('step1').style.display = '';
  document.getElementById('step2').style.display = 'none';

  // Jika ada custom label/range, reset juga
  const minSkill = document.getElementById('minSkillRange');
  const maxSkill = document.getElementById('maxSkillRange');
  if (minSkill) updateSkillBar(minSkill, 'minSkillValue');
  if (maxSkill) updateSkillBar(maxSkill, 'maxSkillValue');
}

  function capitalizeWords(str) {
    return str.replace(/\b\w/g, l => l.toUpperCase());
  }

  // Set active menu button and update UI
  function setActiveMenu(btn) {
  document.querySelectorAll('.btn-menu').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('formCreateMabar').style.display = 'none';
  document.getElementById('mainBarengSection').style.display = '';
  document.getElementById('mainbarengGrid').style.display = '';
  fetchAndRenderMainBareng();
}

let allWilayah = {};

fetch('wilayah_detail.json')
  .then(res => res.json())
  .then(data => {
    allWilayah = data;
    window.allWilayah = allWilayah;
    initAutocomplete();
  })

  // Fungsi untuk deteksi wilayah
function detectWilayah(alamat) {
  if (!alamat || !window.allWilayah) return '-';
  const alamatLower = alamat.toLowerCase();

  let kecamatan = '';
  let kotaKab = '';
  let kecLen = 0;
  let kotaLen = 0;

  Object.keys(window.allWilayah).forEach(nama => {
    const namaLower = nama.toLowerCase();
    if (alamatLower.includes(namaLower) || namaLower.includes(alamatLower)) {
      const jenis = window.allWilayah[nama].jenis;
      if (jenis === 'kecamatan' && nama.length > kecLen) {
        kecamatan = nama;
        kecLen = nama.length;
      }
      if ((jenis === 'kabupaten' || jenis === 'kota') && nama.length > kotaLen) {
        kotaKab = nama;
        kotaLen = nama.length;
      }
    }
  });

  if (kecamatan && kotaKab) return `${capitalizeWords(kecamatan)}, ${capitalizeWords(kotaKab)}`;
  if (kecamatan) return capitalizeWords(kecamatan);
  if (kotaKab) return capitalizeWords(kotaKab);
  return '-';
}

function initAutocomplete() {
  const input = document.getElementById('mainbarengLocationAutocomplete');
  const list = document.getElementById('mainbarengLocationSuggestions');
  input.addEventListener('input', function() {
    const keyword = this.value.trim().toLowerCase();
    list.innerHTML = '';
    if (!keyword || !window.allWilayah) return;
    const wilayahList = Object.keys(window.allWilayah);
    const filtered = wilayahList.filter(l => l.includes(keyword)).slice(0, 5);
    filtered.forEach(lokasi => {
      const li = document.createElement('li');
      li.textContent = capitalizeWords(lokasi);
      li.onclick = () => {
        input.value = capitalizeWords(lokasi);
        list.innerHTML = '';
        filterMainbarengByLocation(lokasi);
      };
      list.appendChild(li);
    });
  });
}

  // Render pagination controls
  function renderPagination(totalPages) {
    const pagination = document.getElementById('paginationNav');
    pagination.innerHTML = '';

    if (totalPages <= 1) return;

    // Prev button
    const prevBtn = document.createElement('button');
    prevBtn.textContent = '‚Äπ';
    prevBtn.disabled = currentPage === 1;
    prevBtn.setAttribute('aria-label', 'Previous page');
    prevBtn.onclick = () => {
      if (currentPage > 1) {
        currentPage--;
        scrollToTop();
      }
    };
    pagination.appendChild(prevBtn);

    // Page number buttons (show max 5)
    let startPage = 1;
    let endPage = totalPages;
    if (totalPages > 5) {
      if (currentPage <= 3) {
        startPage = 1;
        endPage = 5;
      } else if (currentPage + 2 >= totalPages) {
        startPage = totalPages - 4;
        endPage = totalPages;
      } else {
        startPage = currentPage - 2;
        endPage = currentPage + 2;
      }
    }
    for (let i = startPage; i <= endPage; i++) {
      const pageBtn = document.createElement('button');
      pageBtn.textContent = i.toString();
      pageBtn.className = (i === currentPage) ? 'active' : '';
      pageBtn.setAttribute('aria-label', `Goto page ${i}`);
      pageBtn.onclick = () => {
        currentPage = i;
        scrollToTop();
      };
      pagination.appendChild(pageBtn);
    }

    // Next button
    const nextBtn = document.createElement('button');
    nextBtn.textContent = '‚Ä∫';
    nextBtn.disabled = currentPage === totalPages;
    nextBtn.setAttribute('aria-label', 'Next page');
    nextBtn.onclick = () => {
      if (currentPage < totalPages) {
        currentPage++;
        scrollToTop();
      }
    };
    pagination.appendChild(nextBtn);
  }

  // Attach event for search enter key
  document.getElementById('searchInput').addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
    }
  });

  document.getElementById('globalEventSearchInput').addEventListener('input', function() {
  const mainBarengBtn = document.querySelector('.btn-menu');
  if (mainBarengBtn && !mainBarengBtn.classList.contains('active')) {
    setActiveMenu(mainBarengBtn);
  }
  fetchAndRenderMainBareng();
});

  document.getElementById('globalSearchBar').addEventListener('submit', function(e) {
  e.preventDefault();
});

</script>
</body>
</html>